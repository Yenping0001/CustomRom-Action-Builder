name: Build Porject Infinity X

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      DEVICE_CODENAME: a32x
      LUNCH_TARGET: evolution_a32x-userdebug
      BUILD_TYPE: userdebug
      CCACHE_DIR: /home/runner/ccache
      MAKE_THREADS: -j$(nproc)

    steps:
    - name: Checkout manifest
      uses: actions/checkout@v3

    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y bc bison build-essential curl flex git gnupg gperf libncurses5-dev \
          libssl-dev libxml2 libxml2-utils lzop pngcrush rsync schedtool squashfs-tools \
          xsltproc zip zlib1g-dev openjdk-11-jdk repo ccache

    - name: Initialize repo and sync Evolution X sources
      run: |
        mkdir -p ~/rom && cd ~/rom
        repo init --no-repo-verify --git-lfs -u https://github.com/ProjectInfinity-X/manifest -b 16 -g default,-mips,-darwin,-notdefault
        repo sync -c --no-clone-bundle --no-tags --optimized-fetch --prune --force-sync -j$(nproc --all)
        
    - name: Clone device, kernel, and vendor trees
      run: |
        cd ~/rom
        git clone https://github.com/Yenping0001/android_device_samsung_a32x.git device/samsung/a32x
        git clone https://github.com/Yenping0001/android_kernel_samsung_a32x.git kernel/samsung/a32x
        git clone https://github.com/Yenping0001/vendor_samsung_a32x.git vendor/samsung/a32x

    - name: Setup ccache
      run: |
        export USE_CCACHE=1
        ccache -M 50G

    - name: Lunch and build
      run: |
        cd ~/rom
        source build/envsetup.sh
        lunch $LUNCH_TARGET
        make bacon $MAKE_THREADS

    - name: Upload ROM artifact
      uses: actions/upload-artifact@v4
      with:
        name: EvolutionX-ROM
        path: ~/rom/out/target/product/$DEVICE_CODENAME/*.zip
